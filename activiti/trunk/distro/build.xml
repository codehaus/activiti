<?xml version="1.0" encoding="UTF-8"?>

<project name="activiti.distro" default="distro">
  
  <property file="${user.home}/.activiti/build.properties" />

  <property name="activiti.version" value="5.0-SNAPSHOT" /> 
  <property name="target.distro.root" value="target/activiti-${activiti.version}" />
	<property name="activiti.website" value="../../activiti-website" />

  <condition property="mvn.executable" value="mvn.bat" else="mvn">
     <os family="windows"/>
  </condition>

  <condition property="ls.executable" value="cmd" else="ls">
     <os family="windows"/>
  </condition>

	<condition property="ls.executable.options" value="/c dir /B" else="">
     <os family="windows"/>
  </condition>


  <target name="clean">
    <delete dir="target" />
  </target>

  <target name="distro" depends="build.modules, build.userguide, build.javadocs">
    <mkdir dir="${target.distro.root}/lib" />
    <copy todir="${target.distro.root}">
      <fileset dir="src" />
    </copy>
 
  	<mkdir dir="${target.distro.root}/examples/activiti-engine-examples/src" />
    <copy todir="${target.distro.root}/examples/activiti-engine-examples/src">
      <fileset dir="../modules/activiti-engine/src/test/java">
        <include name="org/activiti/examples/**" />
      </fileset>
      <fileset dir="../modules/activiti-engine/src/test/resources">
        <include name="org/activiti/examples/**" />
        <include name="activiti.cfg.xml" />
        <include name="logging.properties" />
      </fileset>
    </copy>

    <mkdir dir="${target.distro.root}/examples/activiti-spring-examples/src" />
    <copy todir="${target.distro.root}/examples/activiti-spring-examples/src">
      <fileset dir="../modules/activiti-spring/src/test/java">
        <include name="org/activiti/examples/**" />
      </fileset>
      <fileset dir="../modules/activiti-spring/src/test/resources">
        <include name="org/activiti/examples/**" />
      </fileset>
    </copy>

    <copy todir="${target.distro.root}/setup/files/examples">
      <fileset dir="..">
        <include name="pom.xml" />
        <include name="modules/activiti-engine/pom.xml" />
        <include name="modules/activiti-spring/pom.xml" />
      </fileset>
    </copy>
  
    <copy todir="${target.distro.root}/docs/xsd">
      <fileset dir="../modules/activiti-engine/src/main/resources/org/activiti/impl/bpmn/parser">
      	<include name="*.xsd" />
      </fileset>
    	<fileset dir="../modules/activiti-engine/src/main/resources/org/activiti/impl/cfg">
    	  <include name="*.xsd" />
    	</fileset>
    </copy>
  
    <mkdir dir="${target.distro.root}/lib" />
    <copy todir="${target.distro.root}/lib">
    	<fileset dir="../modules/activiti-engine/target">
    		<include name="activiti-engine-*.jar"/>
    	</fileset>
      <fileset dir="../modules/activiti-spring/target">
        <include name="activiti-spring-*.jar"/>
      </fileset>
    	<!--added to copy activiti-cycle-*.jar
    	  we have to include it, otherwise we get a NPE in the ant setup (why??)
    	-->
      <fileset dir="../modules/activiti-cycle/target">
        <include name="activiti-cycle-*.jar"/>
      </fileset>
    </copy>
  	
    <exec executable="${mvn.executable}" dir="../modules/activiti-engine">
      <arg line="dependency:copy-dependencies -DoutputDirectory=../../distro/${target.distro.root}/setup/files/libs/engine/runtime"/>
    </exec>
    
    <exec executable="${mvn.executable}" dir="../modules/activiti-spring">
      <arg line="dependency:copy-dependencies -DoutputDirectory=../../distro/${target.distro.root}/setup/files/libs/engine/runtime/feature-spring"/>
    </exec>
    
    <exec executable="${mvn.executable}" dir="../modules/activiti-cycle">
      <arg line="dependency:copy-dependencies -DoutputDirectory=../../distro/${target.distro.root}/setup/files/libs/cycle/runtime"/>
    </exec>
    
    <exec executable="${mvn.executable}" dir="../modules/activiti-webapp-rest">
      <arg line="dependency:copy-dependencies -DoutputDirectory=../../distro/${target.distro.root}/setup/files/libs/webapps-rest"/>
    </exec>
    
    <exec output="target/libs.engine.txt" executable="${ls.executable}">
      <arg line="${ls.executable.options} ${target.distro.root}/setup/files/libs/engine/runtime"/>
    </exec>

    <exec output="target/libs.spring.txt" executable="${ls.executable}">
      <arg line="${ls.executable.options} ${target.distro.root}/setup/files/libs/engine/runtime/feature-spring"/>
    </exec>

    <exec output="target/libs.cycle.txt" executable="${ls.executable}">
      <arg line="${ls.executable.options} ${target.distro.root}/setup/files/libs/cycle/runtime"/>
    </exec>

    <delete>
      <fileset dir="${target.distro.root}/setup/files/libs/engine/runtime/feature-spring" 
               includesfile="target/libs.engine.txt" />
      <fileset dir="${target.distro.root}/setup/files/libs/cycle/runtime" 
               includesfile="target/libs.engine.txt" />
      <fileset dir="${target.distro.root}/setup/files/libs/webapps-rest" 
                 includesfile="target/libs.engine.txt" />
      <fileset dir="${target.distro.root}/setup/files/libs/cycle/runtime" 
               includesfile="target/libs.spring.txt" />
      <fileset dir="${target.distro.root}/setup/files/libs/webapps-rest" 
                 includesfile="target/libs.spring.txt" />
      <fileset dir="${target.distro.root}/setup/files/libs/webapps-rest" 
                 includesfile="target/libs.cycle.txt" />
      <fileset dir="${target.distro.root}/setup/files/libs/engine/runtime">
        <include name="ant-*.jar" />
      </fileset>
    </delete>

    <mkdir dir="${target.distro.root}/setup/files/libs/engine/runtime/feature-openjpa" />
  	<move todir="${target.distro.root}/setup/files/libs/engine/runtime/feature-openjpa">
  		<fileset dir="${target.distro.root}/setup/files/libs/engine/runtime">
  			<include name="persistence-api-*.jar"/>
        <include name="openjpa-*.jar"/>
        <include name="serp-*.jar"/>
        <include name="commons-logging-*.jar"/>
        <include name="commons-lang-*.jar"/>
        <include name="commons-collections-*.jar"/>
        <include name="commons-pool-*.jar"/>
        <include name="geronimo-jms_1.1_spec-*.jar"/>
        <include name="geronimo-jta_1.1_spec-*.jar"/>
        <include name="geronimo-jpa_3.0_spec-*.jar"/>
  	  </fileset>
  	</move>

  	<mkdir dir="${target.distro.root}/setup/files/libs/engine/runtime/feature-groovy" />
    <move todir="${target.distro.root}/setup/files/libs/engine/runtime/feature-groovy">
      <fileset dir="${target.distro.root}/setup/files/libs/engine/runtime">
        <include name="groovy-all-*.jar"/>
      </fileset>
    </move>
    
  	<mkdir dir="${target.distro.root}/setup/files/libs/engine/runtime/feature-jdk5-scripting" />
    <move todir="${target.distro.root}/setup/files/libs/engine/runtime/feature-jdk5-scripting">
      <fileset dir="${target.distro.root}/setup/files/libs/engine/runtime">
        <include name="livetribe-jsr223-*.jar"/>
      </fileset>
    </move>
      	
    <mkdir dir="${target.distro.root}/setup/files/libs/engine/runtime/feature-email" />
    <move todir="${target.distro.root}/setup/files/libs/engine/runtime/feature-email">
      <fileset dir="${target.distro.root}/setup/files/libs/engine/runtime">
        <include name="mail-*.jar"/>
        <include name="commons-email-*.jar"/>
        <include name="activation-*.jar"/>
      </fileset>
    </move>

    <mkdir dir="${target.distro.root}/setup/files/libs/engine/test" />
    <move todir="${target.distro.root}/setup/files/libs/engine/test">
      <fileset dir="${target.distro.root}/setup/files/libs/engine/runtime">
      	<include name="*.jar" />
        <exclude name="mybatis-*.jar"/>
        <exclude name="activiti-engine-*.jar"/>
      </fileset>
    </move>
  	
    <mkdir dir="${target.distro.root}/setup/files/webapps/activiti-probe.war" />
    <unzip dest="${target.distro.root}/setup/files/webapps/activiti-probe.war" 
           src="../modules/activiti-webapp-probe/target/activiti-webapp-probe-${activiti.version}.war"/>
    <mkdir dir="${target.distro.root}/setup/files/webapps/libs" />
    <move todir="${target.distro.root}/setup/files/webapps/libs/WEB-INF/lib">
      <fileset dir="${target.distro.root}/setup/files/webapps/activiti-probe.war/WEB-INF/lib" />
    </move>
    
    <mkdir dir="${target.distro.root}/setup/files/webapps/activiti-cycle.war" />
    <unzip dest="${target.distro.root}/setup/files/webapps/activiti-cycle.war" 
           src="../modules/activiti-webapp-cycle/target/activiti-webapp-cycle-${activiti.version}.war"/>
    <delete>
      <fileset dir="${target.distro.root}/setup/files/webapps/activiti-cycle.war/WEB-INF/lib" />
    </delete>

    <mkdir dir="${target.distro.root}/setup/files/webapps/activiti-explorer.war" />
    <unzip dest="${target.distro.root}/setup/files/webapps/activiti-explorer.war" 
           src="../modules/activiti-webapp-explorer/target/activiti-webapp-explorer-${activiti.version}.war"/>
    <delete>
      <fileset dir="${target.distro.root}/setup/files/webapps/activiti-explorer.war/WEB-INF/lib" />
    </delete>
    
  	<mkdir dir="${target.distro.root}/setup/files/webapps/activiti-rest.war" />
    <unzip dest="${target.distro.root}/setup/files/webapps/activiti-rest.war" 
           src="../modules/activiti-webapp-rest/target/activiti-webapp-rest-${activiti.version}.war"/>
  	<delete>
  		<fileset dir="${target.distro.root}/setup/files/webapps/activiti-rest.war/WEB-INF/lib" />
  	</delete>

    <!-- Copy activiti-cycle, spring-surf and xstream jars to lib directory of activiti-rest -->
    <copy todir="${target.distro.root}/setup/files/webapps/activiti-rest.war/WEB-INF/lib">
    	<fileset dir="../modules/activiti-cycle/target">    	  
    		<include name="activiti-cycle-*.jar"/>    		
    		<include name="spring-surf-*.jar"/>
    	</fileset>
    	<fileset dir="../modules/activiti-webapp-rest/target/activiti-webapp-rest-${activiti.version}/WEB-INF/lib/">
    		<include name="xstream-*.jar"/>
    		<include name="xpp3_min-*.jar"/>
    		<include name="com.noelios.restlet*.jar"/>
    		<include name="org.restlet*.jar"/>
    		<include name="mime-util-*.jar"/>
    		<include name="slf4j-api-*.jar"/>
    		<include name="slf4j-jdk14-*.jar"/>
    		<include name="scannotation-*.jar"/>
    		<include name="javassist-*.jar"/>
    		<include name="signavio-core-components-*.jar"/>
    		<include name="jaxb-impl-*.jar"/> 
      	<include name="httpclient-*.jar" />
      	<include name="httpcore-*.jar" />
    	</fileset>
    </copy>

    <mkdir dir="${target.distro.root}/setup/files/webapps/activiti-webapp-init.war" />
    <unzip dest="${target.distro.root}/setup/files/webapps/activiti-webapp-init.war" 
           src="../modules/activiti-webapp-init/target/activiti-webapp-init-${activiti.version}.war"/>

  	<zip destfile="${target.distro.root}.zip">
  		<fileset dir="${target.distro.root}" />
  	</zip>
  </target>
  
  <target name="build.modules">
  	<condition property="nodocs.profile" value=",nodocs" else="">
  		<equals arg1="${nodocs}" arg2="" />
  	</condition>
    <exec executable="${mvn.executable}" dir=".." failonerror="true">
      <arg line="-Pdistro${nodocs.profile} clean install" />
    </exec>
  </target>
  
  <target name="build.userguide" unless="nodocs" >
  	 <echo message="On failure, make sure that you have installed the Xalan libs by executing the 'install.xalan.libs' target in the 'userguide' folder."></echo>
    <ant antfile="../userguide/build.xml" inheritall="false" />
    <mkdir dir="${target.distro.root}/docs/userguide" />
  	<copy todir="${target.distro.root}/docs/userguide">
  		<fileset dir="../userguide/target/html/en" />
  	</copy>
  </target>
  
  <target name="build.javadocs" unless="nodocs">
    <exec executable="${mvn.executable}" dir="../modules/activiti-engine">
      <arg line="javadoc:javadoc" />
    </exec>
    <mkdir dir="${target.distro.root}/docs/javadocs" />
    <copy todir="${target.distro.root}/docs/javadocs">
      <fileset dir="../modules/activiti-engine/target/site/apidocs" />
    </copy>
  </target>
	
	<target name="publish.docs" depends="build.javadocs, build.userguide">
		<mkdir dir="${activiti.website}/javadocs" />
    <copy todir="${activiti.website}/javadocs" overwrite="true">
      <fileset dir="../modules/activiti-engine/target/site/apidocs" />
    </copy>
    <mkdir dir="${activiti.website}/userguide" />
    <copy todir="${activiti.website}/userguide" overwrite="true">
      <fileset dir="../userguide/target/html/en" />
    </copy>
    <copy todir="${activiti.website}" overwrite="true">
      <fileset dir="src">
      	<include name="readme.html" />
     </fileset>
    </copy>
	</target>
	
</project>